{% extends "pylucid/css_anchor_div.html" %}

{% block plugin_content %}
{% extrahead %}
<!-- GoogleMaps.html extrahead START -->
<!--<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script> -->
<script type="text/javascript" src="http://www.google.com/jsapi"></script>

<script type="text/javascript">
   google.load("maps", "3",  {other_params:"sensor=false"});

// this variable will collect the html which will eventually be placed in the side_bar
var side_bar_html = "";

// arrays to hold copies of the markers and html used by the side_bar
// because the function closure trick doesnt work there
var gmarkers = [];

// global infowindow
var infowindow;
   
function createMarker(latlng,place,desc,map){   
   var marker = new google.maps.Marker({position: latlng, map: map});
   var html = '<strong>'+place+'</strong>'+desc;
   google.maps.event.addListener(marker, "click", function() {
      if (infowindow) infowindow.close();
      infowindow = new google.maps.InfoWindow({content: html});
      infowindow.open(map, marker);
   });
   // save the info we need to use later for the side_bar
   gmarkers.push(marker);
   
   // add a line to the side_bar html
   side_bar_html += '<li><a href="javascript:myclick(' + (gmarkers.length-1) + ')">' + place + '<\/a><\/li>';   
 
   return marker;
}

// This function picks up the click and opens the corresponding info window
function myclick(i) {
   google.maps.event.trigger(gmarkers[i], "click");
}


function KMLparser(path,map){
   // THIS NEEDS NEWER JQUERY THAN PROVIDED WITH CURRENT DJANGO GIT VERSION (verified with 1.5.1)
   // otherwise there are issues with IE8 (and others maybe)
   jQuery.get(path , {}, function(data) {  
      var placemarks = data.documentElement.getElementsByTagName("Placemark");   
      side_bar_html = "<ul class=\"side_bar_html\">";
      for(var i=0; i<placemarks.length; i++){            
         var coordinates;
         coordinates = placemarks[i].getElementsByTagName( "coordinates" )[0].childNodes[0].nodeValue
         for(var chunk=1;  chunk<placemarks[i].getElementsByTagName("coordinates")[0].childNodes.length;chunk++){
             coordinates+=placemarks[i].getElementsByTagName("coordinates")[0].childNodes[chunk].nodeValue;
         }
   
         coordinates = coordinates.split(" ");
         for(var j=0; j<coordinates.length;j++){
            coordinates[j] = coordinates[j].split(",");
         }
   
         if(coordinates.length == 1){
            var latlng = new google.maps.LatLng(parseFloat(coordinates[0][1]),parseFloat(coordinates[0][0]));
            var name = placemarks[i].getElementsByTagName("name")[0].childNodes[0].nodeValue;
            var desc = "";
            try {
               desc = '<p>'+placemarks[i].getElementsByTagName("description")[0].childNodes[0].nodeValue+'</p>';
            }
            catch (e)
            {
               desc = "";
            }
 
            var sDesc = desc.replace("file:///home/chris/MyAlbums/ArticleMedia/", "/article_media/");
            var marker = createMarker(latlng,name,sDesc,map);
            marker.setMap(map);
         }
         else
         {
            var points = new Array();               
            for(var j=0; j<coordinates.length; j++){
               points.push(new google.maps.LatLng(parseFloat(coordinates[j][1]),parseFloat(coordinates[j][0])));   
            }
   
            var pl = new google.maps.Polyline({
               path: points,
               strokeColor: "#FF0000",
               strokeWidth:4,
               strokeOpacity: 0.8
             });
             pl.setMap(map);
         }                        
      }         
      side_bar_html += "<\/ul>";
      // put the assembled side_bar_html contents into the side_bar div
      document.getElementById("side_bar").innerHTML = side_bar_html;

   });
   return ;
}

function draw_google_map(map_slug, map_lon, map_lat, map_zoom, marker_html, marker_lon, marker_lat, marker_width, marker_height, map_kmlurl){
    var latlng = new google.maps.LatLng(map_lat, map_lon);
    var myOptions = {
      zoom: map_zoom,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("google_map_"+map_slug), myOptions);

    var markerLatlng = new google.maps.LatLng(marker_lat, marker_lon);
    var marker = new google.maps.Marker({
         position: markerLatlng,
         title:marker_html
     });
    marker.setMap(map);     
    KMLparser(map_kmlurl, map);


}

function initialize() {
    marker_html = "{{ marker_html }}";

    try {marker_html} catch (e) {
        log("Wrong marker html code!");
        marker_html="";
    }
   
   draw_google_map("{{ map.name }}", {{ map.lon }}, {{ map.lat }}, {{ map.zoom }}, marker_html, {{ marker_lon }}, {{ marker_lat }}, {{ map.marker_width }}, {{ map.marker_height }}, "{{ map.kmlurl }}");
}

   
google.setOnLoadCallback(initialize);
</script>
<!-- GoogleMaps.html extrahead END -->
{% endextrahead %}
<div id="google_map_{{map.name}}" class="google_map" style="width: {{ map.width }}; height: {{ map.height }};">
    <noscript><h3 class="no_anchor">Error: Javascript is needed.</h3></noscript>
</div>
<div id="side_bar"></div>
{% include "StreetMap/includes/edit_link.html" %}
{% include "StreetMap/includes/GoogleMaps_link.html" %}
{% endblock %}
